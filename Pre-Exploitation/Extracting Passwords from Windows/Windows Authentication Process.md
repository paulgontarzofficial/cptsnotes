![[Pasted image 20251024211100.png]]
- The windows auth process is dense to say the least, it goes through a lot of modules that are responsible for logon, credential retrieval, and verification. 
- The LSA (Local Security Authority) is a protected subsystem that authenticates users, manages local logins, and oversees all aspects of local security

Local interactive logon is handled through the coordination of several components: the logon process ([WinLogon](https://www.microsoftpressstore.com/articles/article.aspx?p=2228450&seqNum=8)), the logon user interface process (`LogonUI`), credential providers, the Local Security Authority Subsystem Service (`LSASS`), one or more authentication packages, and either the Security Accounts Manager (`SAM`) or Active Directory. Authentication packages, in this context, are Dynamic-Link Libraries (DLLs) responsible for performing authentication checks. For example, for non-domain-joined and interactive logins, the `Msv1_0.dll` authentication package is typically used.

## LSASS (Local Security Authority Subsystem Service)
- Comprised of multiple modules and governs all auth processes. 

Location: `%SystemRoot%\System32\Lsass.exe`

![[Pasted image 20251024211637.png]]

|**Authentication Packages**|**Description**|
|---|---|
|`Lsasrv.dll`|The LSA Server service both enforces security policies and acts as the security package manager for the LSA. The LSA contains the Negotiate function, which selects either the NTLM or Kerberos protocol after determining which protocol is to be successful.|
|`Msv1_0.dll`|Authentication package for local machine logons that don't require custom authentication.|
|`Samsrv.dll`|The Security Accounts Manager (SAM) stores local security accounts, enforces locally stored policies, and supports APIs.|
|`Kerberos.dll`|Security package loaded by the LSA for Kerberos-based authentication on a machine.|
|`Netlogon.dll`|Network-based logon service.|
|`Ntdsa.dll`|This library is used to create new records and folders in the Windows registry.|
## SAM Database

The Security Account Manager is a database file that the windows OS stores user account credentials in. 
- User passwords are stored as hashes in the registry, typically within the form of LM or NTLM hashes. 
- Location: `%SystemRoot%\system32\config\SAM`
- Active Directory Database: `%SystemRoot%\ntds.dit`

## Credential Manager
![[Pasted image 20251024211956.png]]
Credentials that have been saved are saved in the location below: 
```powershell-session
PS C:\Users\[Username]\AppData\Local\Microsoft\[Vault/Credentials]\
```

## NTDS
- It is very common to encounter network environments where the Windows systems are joined to a domain. In such environments, logon requests are sent to Domain Controllers within the same Active Directory forest. Each DC hosts a file called ntds.dit, which is synced between all domain controllers, with the exception of the RODC. 

NTDS dit file can provide us with some valuable information to include: 
- User accounts (username & password hash)
- Group accounts
- Computer accounts
- Group policy objects

